<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Giat Patroli</title>

    <link rel="stylesheet" href="dashboard.css" />
    <link rel="preconnect" href="https://www.gstatic.com" />
    <link rel="dns-prefetch" href="https://www.gstatic.com" />

    <style>
      .status {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
      }
      .status.online {
        background: #4caf50;
        color: #fff;
      }
      .status.offline {
        background: #b71c1c;
        color: #fff;
      }

      .progress-box {
        width: 100%;
        height: 16px;
        background: #eee;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff7043, #e53935);
        width: 0;
        transition: width 0.4s ease;
      }

      .card-patroli {
        max-width: 400px;
        margin: 20px auto;
        padding: 16px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        text-align: center;
      }

      .menu-card {
        transition: transform 0.2s, background 0.3s;
      }
      .menu-card:hover {
        transform: scale(1.05);
      }

      .menu-card.disabled {
        pointer-events: none;
        opacity: 0.6;
        cursor: not-allowed;
      }

      .patroli-status {
        font-size: 0.9rem;
        color: #444;
      }
    </style>
  </head>

  <body>
    <input type="hidden" id="nipHidden" />

    <header class="header">
      <div class="profile">
        <img
          id="fotoUser"
          src="../assets/default-avatar.png"
          alt="Foto Petugas"
          class="foto-user"
          onerror="this.src='../assets/default-avatar.png'"
        />

        <h1 class="app-title">GIAT SECURITY PATROLI</h1>
        <p id="infoUser">
          <span id="namaUser">Nama Security</span> |
          <span id="perusahaan">Perusahaan</span>
        </p>

        <p
          id="greeting"
          style="margin: 5px 0; font-weight: bold; color: #444"
        ></p>

        <span id="statusOnline" class="status offline">Offline</span>
        <div id="dateTime" class="datetime">--/--/---- --:--:--</div>
      </div>

      <svg
        class="wave"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 1440 120"
        preserveAspectRatio="none"
      >
        <path
          fill="#f7f7f7"
          d="M0,64 C360,120 1080,0 1440,80 L1440,0 L0,0 Z"
        ></path>
      </svg>
    </header>

    <div class="card-patroli">
      <h2>üìç Patroli Area</h2>
      <div id="patroliProgress" class="progress-box">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <p id="patroliStatus" class="patroli-status">
        0 dari 5 patroli dilakukan.<br />
        <small>‚è≥ Progress akan direset otomatis setiap 12 jam.</small>
      </p>
    </div>

    <main class="menu-container">
      <a href="#" class="menu-card" onclick="bukaJadwalPatroli()">
        <div class="icon">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <p>Jadwal Patroli</p>
      </a>

      <a href="panduan.html" class="menu-card">
        <div class="icon">üìö</div>
        <p>Cara Penggunaan</p>
      </a>

      <a href="javascript:void(0)" class="menu-card disabled">
        <div class="icon">üîî</div>
        <p>Notifikasi</p>
        <small style="color: #b71c1c; display: block"
          >Sedang dalam pengembangan</small
        >
      </a>
    </main>

    <a href="#" class="menu-card" onclick="logoutUser()">
      <div class="icon">üö™</div>
      <p>Logout</p>
    </a>

    <footer class="footer">
      <p>&copy; 2025 GIAT PATROLI ‚Ä¢ <span id="tahunSekarang"></span></p>
    </footer>

    <script>
      document.getElementById("tahunSekarang").textContent =
        new Date().getFullYear();

      function updateDateTime() {
        const now = new Date();
        document.getElementById("dateTime").textContent =
          now.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
          }) +
          " , " +
          now.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
      }
      setInterval(updateDateTime, 1000);
      updateDateTime();
    </script>

    <script type="module">
      let userData = JSON.parse(localStorage.getItem("userData"));

      if (userData && userData.foto && !userData.fotoUrl) {
        userData.fotoUrl = userData.foto;
        delete userData.foto;
        localStorage.setItem("userData", JSON.stringify(userData));
      }

      if (userData) {
        document.getElementById("nipHidden").value = userData.nip;
        document.getElementById("namaUser").textContent = userData.nama;
        document.getElementById("perusahaan").textContent =
          userData.perusahaanNama || "-";

        const fotoUser = document.getElementById("fotoUser");
        fotoUser.src =
          userData.fotoUrl && userData.fotoUrl.trim() !== ""
            ? userData.fotoUrl
            : "../assets/default-avatar.png";

        document.getElementById("greeting").textContent =
          "üëã Selamat datang, " + userData.nama + "!";
      } else {
        alert("‚ö†Ô∏è Silakan login terlebih dahulu.");
        window.location.href = "../login.html";
      }

      window.logoutUser = function () {
        if (confirm("Apakah Anda yakin ingin keluar?")) {
          localStorage.removeItem("userData");
          window.location.href = "../login.html";
        }
      };
    </script>

    <script>
      const maxArea = 5;
      function updatePatroliStatus() {
        const progress = JSON.parse(
          localStorage.getItem("patroliProgress") || "{}"
        );
        const now = Date.now();

        let areaNow = progress.currentArea || 1;
        let startTime = progress.startTime || now;

        if (now - startTime > 12 * 60 * 60 * 1000) {
          localStorage.removeItem("patroliProgress");
          areaNow = 1;
          startTime = now;
          localStorage.setItem(
            "patroliProgress",
            JSON.stringify({ currentArea: areaNow, startTime })
          );
        }

        const areaDone = areaNow > 1 ? areaNow - 1 : 0;
        const progressPercent = Math.min((areaDone / maxArea) * 100, 100);

        document.getElementById("progressBar").style.width =
          progressPercent + "%";

        document.getElementById("patroliStatus").innerHTML =
          `${areaDone} dari ${maxArea} patroli dilakukan.<br>` +
          `<small>‚è≥ Progress akan direset otomatis 12 jam setelah absen terakhir.</small>`;
      }
      document.addEventListener("DOMContentLoaded", updatePatroliStatus);

      function updateOnlineStatus() {
        const el = document.getElementById("statusOnline");
        if (navigator.onLine) {
          el.textContent = "Online";
          el.classList.remove("offline");
          el.classList.add("online");
        } else {
          el.textContent = "Offline";
          el.classList.remove("online");
          el.classList.add("offline");
        }
      }
      updateOnlineStatus();
      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);
    </script>

    <script>
      function bukaJadwalPatroli() {
        localStorage.setItem("filterShiftByTime", "true");
        window.location.href = "../pages/jadwalpatroli.html";
      }

      async function cekShiftAktif() {
        const { db } = await import("../js/firebase.js");
        const { getDocs, collection } = await import(
          "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
        );

        const userData = JSON.parse(localStorage.getItem("userData"));
        if (!userData) return;

        const snap = await getDocs(collection(db, "jadwalPatroli"));
        const now = new Date();
        const current = now.getHours() + now.getMinutes() / 60;

        let aktif = false;
        snap.forEach((d) => {
          const s = d.data();
          if (s.perusahaanId !== userData.perusahaanId) return;
          let [sh, sm] = s.jamMulai.split(":").map(Number);
          let [eh, em] = s.jamSelesai.split(":").map(Number);
          let start = sh + sm / 60;
          let end = eh + em / 60;
          const cross = end <= start;
          if (cross) end += 24;

          if (
            (!cross && current >= start && current < end) ||
            (cross && (current >= start || current < end - 24))
          )
            aktif = true;
        });

        if (aktif) {
          const btn = document.querySelector('[onclick="bukaJadwalPatroli()"]');
          btn.style.background = "#43a047";
          btn.style.color = "#fff";
          btn.querySelector("p").textContent = "Jadwal Patroli (Aktif)";
        }
      }
      cekShiftAktif();
    </script>
  </body>
</html>
