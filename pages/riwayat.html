<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laporan Patroli - Giat Security</title>

    <link rel="stylesheet" href="../style/loading.css" />
    <link rel="stylesheet" href="../style/table-page.css" />
    <!-- ‚úÖ jsPDF + AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table-wrapper table {
        width: 100%;
        min-width: 700px;
        border-collapse: collapse;
      }
      .table-wrapper th,
      .table-wrapper td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        text-align: left;
        font-size: 0.9rem;
      }
      .table-wrapper th {
        background: #ffe0e0;
        color: #b71c1c;
        font-weight: 600;
      }
      @media (max-width: 600px) {
        header h1 {
          font-size: 1.4rem;
        }
        header p {
          font-size: 0.85rem;
        }
        .table-wrapper th,
        .table-wrapper td {
          font-size: 0.85rem;
          padding: 8px;
        }
      }

      .periode-box {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f7f7f7;
        padding: 12px 16px;
        border-left: 4px solid #b71c1c; /* garis aksen */
        border-radius: 8px;
        margin: 15px auto;
        font-size: 1rem;
        font-weight: 500;
        color: #333;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .periode-icon {
        font-size: 1.4rem;
      }

      .periode-text {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>üìä Laporan Patroli</h1>
      <p>Laporan patroli berdasarkan bulan</p>
    </header>

    <div class="periode-box">
      <span class="periode-icon">üìÜ</span>
      <span class="periode-text"
        >Pilih periode untuk melihat laporan patroli yang tersimpan di
        server</span
      >
    </div>

    <div class="container">
      <div class="filter-box">
        Bulan:
        <select id="bulan"></select>
        Tahun:
        <select id="tahun"></select>
        <button id="btnTampil">üîç Tampilkan</button>
        <button onclick="exportPDFwithThumb()">üì∏ Export PDF + Foto</button>
      </div>

      <div class="table-wrapper">
        <table id="laporanTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Tgl</th>
              <th>Jam</th>
              <th>Lokasi</th>
              <th>Area</th>
              <th>Foto</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" style="text-align: center; color: #777">
                Memuat data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer">&copy; 2025 Giat Patroli Security</div>

    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
      <p style="color: white; margin-top: 10px">Memuat data...</p>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbx1r9XWC2Go7qgUU0f0A_0rmJ0EwziNpp3zFfk8apY7OOH76zLlPnSex2H5dK7oYWS_KA/exec";
      const bulanEl = document.getElementById("bulan");
      const tahunEl = document.getElementById("tahun");
      const btnTampil = document.getElementById("btnTampil");

      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("userData") || "{}");
        if (!user.nip) {
          alert("‚ö†Ô∏è Anda belum login!");
          location.href = "../login.html";
          return;
        }

        // ‚úÖ Isi dropdown bulan
        const bulanList = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        bulanList.forEach((b, i) => {
          bulanEl.innerHTML += `<option value="${String(i + 1).padStart(
            2,
            "0"
          )}">${b}</option>`;
        });

        // ‚úÖ Isi dropdown tahun (mundur dari sekarang)
        const yNow = new Date().getFullYear();
        for (let y = yNow; y >= 2023; y--) {
          tahunEl.innerHTML += `<option value="${y}">${y}</option>`;
        }

        // ‚úÖ Set default ke bulan & tahun saat ini
        const now = new Date();
        bulanEl.value = String(now.getMonth() + 1).padStart(2, "0");
        tahunEl.value = String(now.getFullYear());

        // ‚úÖ Load awal
        loadData();

        // Klik tombol tampil
        btnTampil.addEventListener("click", loadData);

        async function loadData() {
          document.getElementById("loadingOverlay").style.display = "flex";
          try {
            const bulan = bulanEl.value;
            const tahun = tahunEl.value;
            const res = await fetch(
              `${scriptURL}?action=getPatroliFiltered&nip=${encodeURIComponent(
                user.nip
              )}&bulan=${bulan}&tahun=${tahun}`
            );
            const rows = await res.json();
            renderTable(rows);
          } catch (err) {
            console.error("Fetch Error:", err);
            alert("‚ùå Gagal memuat data");
          }
          document.getElementById("loadingOverlay").style.display = "none";
        }

        function renderTable(rows) {
          const tb = document.querySelector("#laporanTable tbody");
          tb.innerHTML = "";
          if (!rows.length) {
            tb.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#777;">Tidak ada data periode ini</td></tr>`;
            return;
          }
          rows.forEach((r, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${r.tanggal}</td>
        <td>${r.jam}</td>
        <td>${r.lokasi}</td>
        <td>${r.area}</td>
        <td>${r.keterangan || "-"}</td>
        <td><img src="${
          r.foto
        }" style="max-width:80px;max-height:60px;border-radius:6px;cursor:pointer"
                 onclick="lihatFoto('${r.foto}')"></td>`;
            tb.appendChild(tr);
          });
        }

        window.lihatFoto = function (src) {
          const w = window.open("", "_blank");
          w.document.write(
            `<html><body style="margin:0;display:flex;justify-content:center;align-items:center;background:#000;">
         <img src="${src}" style="max-width:100%;max-height:100%;">
       </body></html>`
          );
        };
      });
    </script>

    <script>
      // üî• Helper: konversi URL ‚Üí Base64 biar bisa dipakai jsPDF
      async function toBase64(url) {
        try {
          const res = await fetch(url, { mode: "cors" });
          const blob = await res.blob();
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (e) {
          console.warn("‚ö†Ô∏è Gagal load gambar:", url, e);
          return null;
        }
      }

      window.exportPDFwithThumb = async function exportPDFwithThumb() {
        const bulan = document.getElementById("bulan").value;
        const tahun = document.getElementById("tahun").value;
        const user = JSON.parse(localStorage.getItem("userData") || "{}");

        if (!user.nip) {
          alert("Anda belum login!");
          return;
        }

        const tableRows = [];
        const fotoList = [];

        // üîë Ambil data dari tabel HTML
        document.querySelectorAll("#laporanTable tbody tr").forEach((tr) => {
          const tds = tr.querySelectorAll("td");
          if (tds.length < 6) return;
          const rowData = [
            tds[0].innerText.trim(),
            tds[1].innerText.trim(),
            tds[2].innerText.trim(),
            tds[3].innerText.trim(),
            tds[4].innerText.trim(),
            tds[5].innerText.trim(),
            "", // kolom foto ‚Üí isi manual
          ];
          tableRows.push(rowData);

          // Simpan URL gambar
          const imgEl = tds[6].querySelector("img");
          fotoList.push(imgEl ? imgEl.src : null);
        });

        if (!tableRows.length) {
          alert("‚ö†Ô∏è Tidak ada data untuk diexport.");
          return;
        }

        // üî• Tampilkan loading overlay
        document.getElementById("loadingOverlay").style.display = "flex";

        // ‚úÖ Preload semua foto jadi Base64
        const base64List = [];
        for (let i = 0; i < fotoList.length; i++) {
          if (fotoList[i]) {
            base64List[i] = await toBase64(fotoList[i]);
          } else {
            base64List[i] = null;
          }
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "pt", "a4");

        // üî• Header PDF
        const bulanList = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        const bulanNama = bulanList[parseInt(bulan) - 1];
        const title = `Laporan Patroli - ${bulanNama} ${tahun}`;

        doc.setFontSize(14);
        doc.text(title, 40, 40);
        doc.setFontSize(10);
        doc.text(`Nama: ${user.nama || "-"}   NIP: ${user.nip}`, 40, 60);

        const headers = [
          ...document.querySelectorAll("#laporanTable thead th"),
        ].map((th) => th.innerText);

        // üî• Buat tabel
        doc.autoTable({
          startY: 80,
          head: [headers],
          body: tableRows,
          didDrawCell: (data) => {
            // sisipkan foto di kolom ke-6
            if (data.section === "body" && data.column.index === 6) {
              const base64Img = base64List[data.row.index];
              if (base64Img) {
                const dim = 30;
                const xPos = data.cell.x + (data.cell.width - dim) / 2;
                const yPos = data.cell.y + 2;
                doc.addImage(base64Img, "JPEG", xPos, yPos, dim, dim);
              }
            }
          },
          styles: { fontSize: 9, cellPadding: 3, minCellHeight: 34 },
          headStyles: { fillColor: [255, 224, 224], textColor: [183, 28, 28] },
          columnStyles: { 6: { cellWidth: 50 } },
        });

        // üî• Sembunyikan overlay & simpan PDF
        document.getElementById("loadingOverlay").style.display = "none";
        doc.save(`Laporan-Patroli-${bulan}-${tahun}-foto.pdf`);
      };
    </script>
  </body>
</html>
