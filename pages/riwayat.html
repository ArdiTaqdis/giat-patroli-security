<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laporan Patroli - Giat Security</title>

    <link rel="stylesheet" href="../style/loading.css" />
    <link rel="stylesheet" href="../style/table-page.css" />
    <!-- ‚úÖ jsPDF + AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table-wrapper table {
        width: 100%;
        min-width: 700px;
        border-collapse: collapse;
      }
      .table-wrapper th,
      .table-wrapper td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        text-align: left;
        font-size: 0.9rem;
      }
      .table-wrapper th {
        background: #ffe0e0;
        color: #b71c1c;
        font-weight: 600;
      }
      @media (max-width: 600px) {
        header h1 {
          font-size: 1.4rem;
        }
        header p {
          font-size: 0.85rem;
        }
        .table-wrapper th,
        .table-wrapper td {
          font-size: 0.85rem;
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>üìä Laporan Patroli</h1>
      <p>Laporan patroli berdasarkan bulan</p>
    </header>

    <div
      style="
        background: #f7f7f7;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
      "
    >
      <p>
        üìÜ Pilih periode untuk melihat laporan patroli yang tersimpan di server.
      </p>
    </div>

    <div class="container">
      <div class="filter-box">
        Bulan:
        <select id="bulan"></select>
        Tahun:
        <select id="tahun"></select>
        <button id="btnTampil">üîç Tampilkan</button>
        <button onclick="exportPDF()">üìÑ Export PDF</button>
      </div>

      <div class="table-wrapper">
        <table id="laporanTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Tgl</th>
              <th>Jam</th>
              <th>Lokasi</th>
              <th>Area</th>
              <th>Foto</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" style="text-align: center; color: #777">
                Memuat data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer">&copy; 2025 Giat Patroli Security</div>

    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
      <p style="color: white; margin-top: 10px">Memuat data...</p>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbw2zRW21O9OaQxDRl58I9BOs7MvtdgqoHTE-oXZOUug1WHRhT1QxsSAOH68WcNji8MAbA/exec";
      const bulanEl = document.getElementById("bulan");
      const tahunEl = document.getElementById("tahun");
      const btnTampil = document.getElementById("btnTampil");

      document.addEventListener("DOMContentLoaded", () => {
        const user = JSON.parse(localStorage.getItem("userData") || "{}");
        if (!user.nip) {
          alert("‚ö†Ô∏è Anda belum login!");
          location.href = "../login.html";
          return;
        }

        // ‚úÖ Isi dropdown bulan
        const bulanList = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        bulanList.forEach((b, i) => {
          bulanEl.innerHTML += `<option value="${String(i + 1).padStart(
            2,
            "0"
          )}">${b}</option>`;
        });

        // ‚úÖ Isi dropdown tahun (mundur dari sekarang)
        const yNow = new Date().getFullYear();
        for (let y = yNow; y >= 2023; y--) {
          tahunEl.innerHTML += `<option value="${y}">${y}</option>`;
        }

        // ‚úÖ Set default ke bulan & tahun saat ini
        const now = new Date();
        bulanEl.value = String(now.getMonth() + 1).padStart(2, "0");
        tahunEl.value = String(now.getFullYear());

        // ‚úÖ Load awal
        loadData();

        // Klik tombol tampil
        btnTampil.addEventListener("click", loadData);

        async function loadData() {
          document.getElementById("loadingOverlay").style.display = "flex";
          try {
            const bulan = bulanEl.value;
            const tahun = tahunEl.value;
            const res = await fetch(
              `${scriptURL}?action=getPatroliFiltered&nip=${encodeURIComponent(
                user.nip
              )}&bulan=${bulan}&tahun=${tahun}`
            );
            const rows = await res.json();
            renderTable(rows);
          } catch (err) {
            console.error("Fetch Error:", err);
            alert("‚ùå Gagal memuat data");
          }
          document.getElementById("loadingOverlay").style.display = "none";
        }

        function renderTable(rows) {
          const tb = document.querySelector("#laporanTable tbody");
          tb.innerHTML = "";
          if (!rows.length) {
            tb.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#777;">Tidak ada data periode ini</td></tr>`;
            return;
          }
          rows.forEach((r, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${r.tanggal}</td>
        <td>${r.jam}</td>
        <td>${r.lokasi}</td>
        <td>${r.area}</td>
        <td><img src="${
          r.foto
        }" style="max-width:80px;max-height:60px;border-radius:6px;cursor:pointer"
                 onclick="lihatFoto('${r.foto}')"></td>`;
            tb.appendChild(tr);
          });
        }

        window.lihatFoto = function (src) {
          const w = window.open("", "_blank");
          w.document.write(
            `<html><body style="margin:0;display:flex;justify-content:center;align-items:center;background:#000;">
         <img src="${src}" style="max-width:100%;max-height:100%;">
       </body></html>`
          );
        };
      });
    </script>
    <script>
      async function exportPDF() {
        // Ambil bulan/tahun yang sedang dipilih
        const bulan = document.getElementById("bulan").value;
        const tahun = document.getElementById("tahun").value;
        const user = JSON.parse(localStorage.getItem("userData") || "{}");
        if (!user.nip) {
          alert("Anda belum login!");
          return;
        }

        // Ambil data dari tabel HTML (bukan fetch lagi, biar sesuai tampilan)
        const rows = [];
        document.querySelectorAll("#laporanTable tbody tr").forEach((tr) => {
          const cols = [...tr.querySelectorAll("td")].map((td) =>
            td.innerText.trim()
          );
          if (cols.length && cols[0] !== "Tidak ada data bulan ini")
            rows.push(cols);
        });

        if (!rows.length) {
          alert("‚ö†Ô∏è Tidak ada data untuk diexport.");
          return;
        }

        // Buat dokumen PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "pt", "a4"); // potrait, point, A4
        const title = `Laporan Patroli - ${bulan}/${tahun}`;
        doc.setFontSize(14);
        doc.text(title, 40, 40);
        doc.setFontSize(10);
        doc.text(`Nama: ${user.nama || "-"}   NIP: ${user.nip}`, 40, 60);

        // Ambil header dari tabel
        const headers = [
          ...document.querySelectorAll("#laporanTable thead th"),
        ].map((th) => th.innerText);

        // Masukkan tabel ke PDF
        doc.autoTable({
          startY: 80,
          head: [headers],
          body: rows,
          styles: { fontSize: 9 },
          headStyles: { fillColor: [255, 224, 224], textColor: [183, 28, 28] },
        });

        // Simpan file
        doc.save(`Laporan-Patroli-${bulan}-${tahun}.pdf`);
      }
    </script>
  </body>
</html>
