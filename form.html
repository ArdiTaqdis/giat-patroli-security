<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patroli 5 Area</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <header class="judul">
    <h1>Absensi Patroli 5 Area</h1>
  </header>

  <div class="container">
    <!-- Foto Profil -->
    <div style="text-align: center;">
      <img id="fotoUser" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User" style="width: 80px; border-radius: 50%;" />
    </div>

    <!-- Info Petugas -->
    <div class="identitas">
      <div><strong>NIP:</strong> <span id="nip">-</span></div>
      <div><strong>Nama:</strong> <span id="nama">-</span></div>
      <div><strong>Perusahaan:</strong> <span id="perusahaan">-</span></div>
    </div>

    <!-- Waktu dan Lokasi -->
    <div class="info-waktu" style="margin-top: 10px;">
      <div><strong>Tanggal:</strong> <span id="tanggal">-</span></div>
      <div><strong>Jam:</strong> <span id="jam">-</span></div>
      <div><strong>Lokasi:</strong> <span id="lokasi">üìç Mengambil lokasi...</span></div>
    </div>

    <!-- Step Area -->
    <div id="progressInfo" style="text-align: center; font-weight: bold; margin-bottom: 10px;">
      Area <span id="areaNow">1</span> dari 5
    </div>

    <div id="stepContainer">
      <h2 id="areaTitle">Area 1</h2>
      <button type="button" onclick="scanQRCode()">üîç Scan QR Code</button>
      <div id="qrResult"></div>
      <div id="reader" style="width: 300px; margin-top: 10px;"></div>

      <button type="button" onclick="ambilFoto()">üì∏ Ambil Foto Area</button>
      <div class="foto-preview" id="previewFoto">
        <span>üì∏ Foto akan tampil di sini</span>
      </div>

      <textarea id="keterangan" placeholder="Keterangan area" rows="3"></textarea>

      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button type="button" id="prevBtn" onclick="prevArea()">‚¨ÖÔ∏è Area Sebelumnya</button>
        <button type="button" id="nextBtn" onclick="nextArea()">‚û°Ô∏è Area Berikutnya</button>
      </div>
    </div>

    <div id="status" style="margin-top: 20px;"></div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="margin-top: 10px;">‚è≥ Loading data...</div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyMo-HUC8VoDEflt6eBTKGrVUMnrbvbjNRLXru9Ddd5Yzko1E07ZXM9_TD3dZzO0wUK8Q/exec";
    let areaNow = 1;
    const maxArea = 5;

    const beforeUnloadHandler = (e) => {
      e.preventDefault();
      e.returnValue = '';
    };

    document.addEventListener("DOMContentLoaded", () => {
      window.addEventListener("beforeunload", beforeUnloadHandler);
      const nip = localStorage.getItem("nipLogin");
      const nama = localStorage.getItem("nama");
      const perusahaan = localStorage.getItem("perusahaan");
      const fotoUser = localStorage.getItem("fotoUser");

      if (!nip || !nama || !perusahaan) {
        alert("Silakan login terlebih dahulu.");
        window.location.href = "index.html";
        return;
      }

      document.getElementById("nip").innerText = nip;
      document.getElementById("nama").innerText = nama;
      document.getElementById("perusahaan").innerText = perusahaan;
      document.getElementById("fotoUser").src = fotoUser || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

      const now = new Date();
      document.getElementById("tanggal").innerText = now.toLocaleDateString("id-ID");
      document.getElementById("jam").innerText = now.toLocaleTimeString("id-ID");
      setInterval(() => {
        document.getElementById("jam").innerText = new Date().toLocaleTimeString("id-ID");
      }, 1000);

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);
            document.getElementById("lokasi").innerText = `Lat: ${lat}, Lon: ${lon}`;
            getAlamatFromKoordinat(lat, lon);
          },
          () => document.getElementById("lokasi").innerText = "‚ùå Akses lokasi ditolak",
          { timeout: 8000 }
        );
      }

      updateAreaUI();
    });

    function getAlamatFromKoordinat(lat, lon) {
      const apiKey = "2bbd755924364128b9e1b32f2ca00375";
      const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${apiKey}&language=id`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.results?.length) {
            const c = data.results[0].components;
            const alamat = [c.hamlet, c.village, c.suburb, c.city_district, c.city || c.county, c.state].filter(Boolean).join(', ');
            document.getElementById("lokasi").innerText = alamat;
          }
        })
        .catch(() => document.getElementById("lokasi").innerText = "Gagal ambil alamat");
    }

    function updateAreaUI() {
      document.getElementById("areaNow").innerText = areaNow;
      document.getElementById("areaTitle").innerText = `Area ${areaNow}`;
      document.getElementById("qrResult").innerHTML = "";
      document.getElementById("reader").innerHTML = "";
      document.getElementById("previewFoto").innerHTML = `<span>üì∏ Foto akan tampil di sini</span>`;
      document.getElementById("keterangan").value = "";

      const areaData = JSON.parse(localStorage.getItem(`area${areaNow}`) || "{}");
      if (areaData.qr) document.getElementById("qrResult").innerHTML = `<strong>‚úÖ QR:</strong> ${areaData.qr}`;
      if (areaData.foto) document.getElementById("previewFoto").innerHTML = `<img src="${areaData.foto}" style="width:100%; border-radius:10px;" />`;
      if (areaData.ket) document.getElementById("keterangan").value = areaData.ket;

      document.getElementById("nextBtn").innerText = areaNow < maxArea ? "‚û°Ô∏è Area Berikutnya" : "üì§ Kirim Semua Data";
    }

    function saveCurrentAreaData(newData) {
      const current = JSON.parse(localStorage.getItem(`area${areaNow}`) || "{}");
      const updated = { ...current, ...newData };
      localStorage.setItem(`area${areaNow}`, JSON.stringify(updated));
    }

    function ambilFoto() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.capture = "environment";
      input.onchange = () => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const base64 = e.target.result;
          document.getElementById("previewFoto").innerHTML = `<img src="${base64}" style="width:100%; border-radius:10px;" />`;
          saveCurrentAreaData({ foto: base64 });
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    let html5QrCode;
    function scanQRCode() {
      const qrResult = document.getElementById("qrResult");
      if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          qrResult.innerHTML = `<strong>‚úÖ QR:</strong> ${decodedText}`;
          saveCurrentAreaData({ qr: decodedText });
          html5QrCode.stop().then(() => (document.getElementById("reader").innerHTML = ""));
        },
        () => {}
      ).catch(err => {
        qrResult.innerHTML = `‚ùå Tidak bisa akses kamera: ${err}`;
      });
    }

    function nextArea() {
      const ket = document.getElementById("keterangan").value;
      saveCurrentAreaData({ ket });

      const areaData = JSON.parse(localStorage.getItem(`area${areaNow}`) || "{}");
      if (!areaData.qr || !areaData.foto) {
        alert(`Mohon isi QR dan Foto untuk Area ${areaNow} terlebih dahulu.`);
        return;
      }

      if (areaNow < maxArea) {
        areaNow++;
        updateAreaUI();
      } else {
        kirimSemuaData();
      }
    }

    async function kirimSemuaData() {
      document.getElementById("loadingOverlay").style.display = "flex";
      const nip = document.getElementById("nip").innerText;
      const nama = document.getElementById("nama").innerText;
      const perusahaan = document.getElementById("perusahaan").innerText;
      const tanggal = document.getElementById("tanggal").innerText || "";
      const jam = document.getElementById("jam").innerText || "";
      const lokasi = document.getElementById("lokasi").innerText || "Lokasi tidak tersedia";

      const formBody = new URLSearchParams({ action: "patroli", nip, nama, perusahaan, tanggal, jam, lokasi });

      for (let i = 1; i <= maxArea; i++) {
        const data = JSON.parse(localStorage.getItem(`area${i}`) || "{}");
        formBody.append(`qr${i}`, data.qr || "");
        formBody.append(`foto${i}`, data.foto || "");
        formBody.append(`ket${i}`, data.ket || "");
      }

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formBody.toString()
        });

        const text = await res.text();
        document.getElementById("status").innerText = text;
        document.getElementById("loadingOverlay").style.display = "none";

        if (text.toLowerCase().includes("berhasil")) {
          alert("‚úÖ Data patroli berhasil dikirim!");
          for (let i = 1; i <= maxArea; i++) localStorage.removeItem(`area${i}`);
          window.removeEventListener("beforeunload", beforeUnloadHandler);
          setTimeout(() => (window.location.href = "index.html"), 2500);
        }
      } catch (err) {
        document.getElementById("loadingOverlay").style.display = "none";
        document.getElementById("status").innerText = "‚ùå Gagal mengirim: " + err.message;
      }
    }

    function prevArea() {
      if (areaNow > 1) {
        areaNow--;
        updateAreaUI();
      }
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f8ff;
      margin: 0;
      padding: 15px;
    }
    .judul { text-align: center; margin-bottom: 10px; }
    .container {
      max-width: 500px; margin: auto; background: #fff; padding: 20px;
      border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .identitas, .info-waktu {
      margin-top: 10px; background: #f3faff; padding: 10px; border-radius: 8px;
    }
    .foto-preview img { width: 100%; border-radius: 8px; margin-top: 10px; }
    textarea {
      width: 100%; padding: 10px; margin-top: 10px;
      border-radius: 6px; border: 1px solid #ccc; resize: none;
    }
    button {
      display: block; width: 100%; margin-top: 15px; padding: 10px;
      background-color: #1976d2; color: white; border: none;
      border-radius: 8px; cursor: pointer;
    }
    button:hover { background-color: #1565c0; }
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background-color: rgba(255,255,255,0.8); z-index: 9999;
      display: none; align-items: center; justify-content: center; flex-direction: column;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #ccc;
      border-top: 5px solid #2196f3; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html>
