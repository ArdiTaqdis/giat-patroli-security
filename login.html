<!DOCTYPE html>
<html lang="id">
  <head>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#d32f2f" />
    <link rel="icon" href="icon-192.png" type="image/png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Giat Patroli Security</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #ff6262, #f03d3d);
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .login-box {
        background: #ffffff;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        text-align: center;
        width: 100%;
        max-width: 360px;
      }
      img {
        width: 80px;
        margin-bottom: 15px;
      }
      h1 {
        font-size: 22px;
        margin-bottom: 30px;
        color: #d61a1a;
      }
      input,
      button {
        width: 100%;
        padding: 12px;
        margin-bottom: 20px;
        border-radius: 10px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      input:focus {
        outline: none;
        border-color: #2196f3;
      }
      button {
        background: #e62020;
        color: white;
        font-weight: bold;
        border: none;
        transition: background 0.3s;
      }
      button:hover {
        background: #881506;
      }
      .footer {
        margin-top: 15px;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>

  <body>
    <div class="login-box">
      <img
        src="https://drive.google.com/thumbnail?id=1LlCPpS__DX-gbvLzbjIBtfRLcFZaaRZQ&sz=s4000"
        alt="Logo"
      />
      <h1>GIAT PATROLI SECURITY</h1>

      <form id="loginForm">
        <input
          type="text"
          id="nipInput"
          placeholder="Masukkan NIP Anda"
          required
        />
        <button type="submit">üîê Login</button>
      </form>

      <div class="footer">¬© 2025 Giat Security Patrol</div>
    </div>

    <script type="module">
      import { db } from "./js/firebase.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // ‚úÖ AUTO LOGIN ‚Äî hanya satu kali pengecekan
      const existingUser = JSON.parse(
        localStorage.getItem("userData") || "null"
      );
      if (existingUser?.nip && existingUser?.nama) {
        console.log("üîì Auto-login:", existingUser.nama);
        window.location.href = "dashboard/dashboard.html";
      }

      // üîë Proses login manual
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const nip = document.getElementById("nipInput").value.trim();
          if (!nip) return;

          try {
            const userRef = doc(db, "dataUser", nip);
            const snap = await getDoc(userRef);

            if (snap.exists()) {
              const data = snap.data();

              localStorage.setItem(
                "userData",
                JSON.stringify({
                  nip: nip,
                  nama: data.nama,
                  perusahaanId: data.perusahaanId || "",
                  perusahaanNama: data.perusahaanNama || data.perusahaan || "-",
                  foto: data.fotoUrl || "",
                })
              );

              window.location.href = "dashboard/dashboard.html";
            } else {
              alert("‚ùå NIP tidak ditemukan.");
            }
          } catch (err) {
            alert("‚ùå Error Firestore: " + err.message);
            console.error(err);
          }
        });
    </script>
  </body>
</html>
